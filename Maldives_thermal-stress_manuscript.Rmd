---
title: "Maldives-thermal-stress-coral-isotopes"
author: "Veronica Radice"
date: "16/09/2021"
output: html_document
---

Accompanying script for Radice et al. manuscript "Trophic plasticity of shallow and mesophotic corals recovering from oceanic thermal stress"

https://github.com/veronicar239/Maldives_Thermal-stress-isotopes

Analysis of coral host and algal symbiont carbon and nitrogen elemental and stable isotope data.
Samples collected in the Maldives, Indian Ocean.

Comparison of 1 year pre-bleaching data (2015) to 10 months post-bleaching data (2017), in relation to the 2016 mass coral bleaching event that occurred in the Maldives (and across the world).

# Load packages
```{r message=FALSE}
library(ggplot2)
library(dplyr)
library(plyr)
library(stringr)
library(nlme) 
library(emmeans)
library(predictmeans) # residplot
library(effects)
library(vegan)
library(magrittr)
library(ggrepel)
library(Cairo)
library(egg)
library(cowplot)
```

# Set working directory
```{r}
setwd("~/Documents/Rprojects/PhD Rprojects/Maldives thermal stress paper_Rproject/")
```

# Import 2015-2017 coral host isotope data
```{r}
# Notes
# removed sample HM682 which had no N or C ug measurements nor d15N nor d13C measurements (analytical lab comment - contained insufficient N or C)
# removed one outlier %C value for
  # Host 2017	HM725	Host	Pachyseris	Shallow	Inner_Sea	Meemu	Kurali
  # Host_C_ug 1220.09, therefore Host_wt-percent_C = 0.33
  # next closest value of Host_C_ug is 832.82
  # contamination of other organic material suspected
# all isotope values with 1 significant digit (e.g. -15.7 per mil)

host.2015.2017 <- read.csv("Host_Maldives_2015-2017_isotopes_Final.csv", header=TRUE)

host.2015.2017[sapply(host.2015.2017, is.character)] <- lapply(host.2015.2017[sapply(host.2015.2017, is.character)], 
                                       as.factor)

# change Year from integer to Factor
host.2015.2017$Year <- as.factor(host.2015.2017$Year)

host.2015.2017$Bleaching <- revalue(host.2015.2017$Year, c("2015" = "Before", "2017" = "After")) 
host.2015.2017$Bleaching <- factor(host.2015.2017$Bleaching, levels = c("Before", "After"))

host.2015.2017$Coral_species <- revalue(host.2015.2017$Coral, c("Galaxea" = "Galaxea fascicularis", "Pachyseris" = "Pachyseris speciosa", "Pocillopora" = "Pocillopora verrucosa"))

host.2015.2017$Depth <- revalue(host.2015.2017$Depth, c("Deep" = "Mesophotic"))
host.2015.2017$Depth <- factor(host.2015.2017$Depth, levels = c("Shallow", "Mesophotic"))
```

# Import 2015-2017 symbiont isotope data
```{r}
# Notes
# all isotope values with 1 significant digit (e.g. -15.7 per mil)

sym.2015.2017 <- read.csv("Symbiont_Maldives_2015-2017_isotopes_Final.csv", header=TRUE)

sym.2015.2017[sapply(sym.2015.2017, is.character)] <- lapply(sym.2015.2017[sapply(sym.2015.2017, is.character)], 
                                       as.factor)

# change Year from integer to Factor
sym.2015.2017$Year <- as.factor(sym.2015.2017$Year)

sym.2015.2017$Bleaching <- revalue(sym.2015.2017$Year, c("2015" = "Before", "2017" = "After")) 
sym.2015.2017$Bleaching <- factor(sym.2015.2017$Bleaching, levels = c("Before", "After"))

sym.2015.2017$Coral_species <- revalue(sym.2015.2017$Coral, c("Galaxea" = "Galaxea fascicularis", "Pachyseris" = "Pachyseris speciosa", "Pocillopora" = "Pocillopora verrucosa"))

sym.2015.2017$Depth <- revalue(sym.2015.2017$Depth, c("Deep" = "Mesophotic"))
sym.2015.2017$Depth <- factor(sym.2015.2017$Depth, levels = c("Shallow", "Mesophotic"))
```

# Import combined host and symbiont data (for ellipse plot)
```{r}
iso <- read.csv("Maldives_2015-2017_isotopes_combined_Final.csv", header=TRUE)

iso[sapply(iso, is.character)] <- lapply(iso[sapply(iso, is.character)], 
                                       as.factor)

iso$Year <- as.factor(iso$Year)  #group
iso$Year <- revalue(iso$Year, c("2015" = "Before")) 
iso$Year <- revalue(iso$Year, c("2017" = "After")) 

iso$Depth <- revalue(iso$Depth, c("Deep" = "Mesophotic"))
iso$Depth <- factor(iso$Depth, levels = c("Shallow", "Mesophotic"))

iso$Coral_species <- revalue(iso$Coral, c("Galaxea" = "Galaxea fascicularis", "Pachyseris" = "Pachyseris speciosa", "Pocillopora" = "Pocillopora verrucosa"))

iso$Fraction <- factor(iso$Tissue_type)
```

```{r}
paired <- read.csv("Maldives_2015-2017_isotopes_combined_Final_paired.csv", header=TRUE)

paired[sapply(paired, is.character)] <- lapply(paired[sapply(paired, is.character)], 
                                       as.factor)

paired$Year <- as.factor(paired$Year)  #group
paired$Year <- revalue(paired$Year, c("2015" = "Before")) 
paired$Year <- revalue(paired$Year, c("2017" = "After")) 

paired$Coral <- revalue(paired$Coral, c("Galaxea" = "Galaxea fascicularis", "Pachyseris" = "Pachyseris speciosa", "Pocillopora" = "Pocillopora verrucosa"))

paired$Depth <- revalue(paired$Depth, c("Deep" = "Mesophotic"))
paired$Depth <- factor(paired$Depth, levels = c("Shallow", "Mesophotic"))
```


########################################################################

# Summary - Coral hosts
```{r}
summary.host <- host.2015.2017 %>%
  group_by(Year, Coral, Depth) %>%
  dplyr::summarise(count = n(), mean_d13C = mean(Host_d13C, na.rm = TRUE), sd_d13C = sd(Host_d13C, na.rm = TRUE), mean_d15N = mean(Host_d15N, na.rm = TRUE), sd_d15N = sd(Host_d15N, na.rm = TRUE), mean_C_percent = mean(Host_wt.percent_C_num, na.rm = TRUE), sd_C_percent = sd(Host_wt.percent_C_num, na.rm = TRUE), mean_N = mean(Host_wt.percent_N_num, na.rm = TRUE), sd_N = sd(Host_wt.percent_N_num, na.rm = TRUE), mean_CN.ratio_molar = mean(Host_CN_molar.ratio, na.rm = TRUE), sd_CN = sd(Host_CN_molar.ratio, na.rm = TRUE))

summary.host

#write.csv(file = "Table Host Maldives 2015-2017 summary.csv", x = summary.host)
```

# Summary - Symbionts
```{r}
summary.sym <- sym.2015.2017 %>%
  group_by(Coral, Depth) %>%
  dplyr::summarise(count = n(), mean_d13C = mean(Symbiont_d13C, na.rm = TRUE), sd_d13C = sd(Symbiont_d13C, na.rm = TRUE), mean_d15N = mean(Symbiont_d15N, na.rm = TRUE), sd_d15N = sd(Symbiont_d15N, na.rm = TRUE), mean_C_percent = mean(Symbiont_wt.percent_C_num, na.rm = TRUE), sd_C_percent = sd(Symbiont_wt.percent_C_num, na.rm = TRUE), mean_N = mean(Symbiont_wt.percent_N_num, na.rm = TRUE), sd_N = sd(Symbiont_wt.percent_N_num, na.rm = TRUE), mean_CN.ratio_molar = mean(Symbiont_CN_molar.ratio, na.rm = TRUE), sd_CN = sd(Symbiont_CN_molar.ratio, na.rm = TRUE))

summary.sym

#write.csv(file = "Table Symb Maldives 2015-2017 summary.csv", x = summary.sym)
```

########################################################################

# Host d15N
```{r}
par(mfrow=c(1,3))
plot(Host_d15N ~ Year * Depth * Coral, data=host.2015.2017)
```

```{r}
hist(host.2015.2017$Host_d15N)
```

```{r}
# Assumption - normal distribution
# Regression models donâ€™t require that outcome variables need to be normally distributed (see: Logistic or Poisson regression models), 
# however MLM (multilevel models) assume that the residuals of the analysis ARE normally distributed

qqnorm(host.2015.2017$Host_d15N,
       ylab="Sample Quantiles")
qqline(host.2015.2017$Host_d15N,
       col="red")
```

```{r}
# Host d15N - LME
host.d15N.lme <- lme(Host_d15N ~ Year * Depth * Coral, random = ~1|Site, data = host.2015.2017, na.action = na.exclude)

host.d15N.lme2 <- lme(Host_d15N ~ Year * Coral, random = ~1|Site, data = host.2015.2017, na.action = na.exclude)

host.d15N.lme3 <- lme(Host_d15N ~ Year * Depth, random = ~1|Site, data = host.2015.2017, na.action = na.exclude)

host.d15N.lme4 <- lme(Host_d15N ~ Depth * Coral, random = ~1|Site, data = host.2015.2017, na.action = na.exclude)
```

```{r}
# model comparison
anova(host.d15N.lme, host.d15N.lme2, host.d15N.lme3, host.d15N.lme4)

# 2.6 difference in AIC between model 1 and model 2 

# What is your goal? Predictive or explanatory modelling? 
## If it is predictive modelling, the simpler model (with fewer parameters) is better. 
## If it is explanatory modelling, you may wish to consider even the second best model because you do not want to leave out an important explanatory variable. 

### Here I am doing explanatory modelling
### therefore I chose model 1, with all three parameters included
```

```{r}
summary(host.d15N.lme)
```

```{r}
anova(host.d15N.lme)
```

```{r}
# Extract and display information on all pairwise comparisons of least-squares means
emmeans(host.d15N.lme, pairwise ~ Year, adjust = "tukey")
```

```{r}
# Extract and display information on all pairwise comparisons of least-squares means
emmeans(host.d15N.lme, pairwise ~ Depth * Coral, adjust = "tukey", simple = "Depth")
```

```{r}
# Extract and display information on all pairwise comparisons of least-squares means
emmeans(host.d15N.lme, pairwise ~ Coral, adjust = "tukey")
```


```{r}
# estimated deviation between each site average value and the overall average
ranef(host.d15N.lme)
#plot(ranef(host.d15N.lme))
```

```{r}
# examine plots of residuals versus fitted values
residplot(host.d15N.lme, level=2)
plot(host.d15N.lme)
hist(residuals(host.d15N.lme))

# test the assumption of normality of deviations of the conditional means of the random effects from the global intercept
qqnorm(host.d15N.lme, ~ranef(., level=1))
```

```{r}
plot(allEffects(host.d15N.lme), ylab="Host d15N")
```

# Host d15N by Year
```{r}
plot.d15N.year <- ggplot(host.2015.2017, aes(x=Bleaching, y=Host_d15N, fill = Bleaching)) + 
  geom_boxplot(alpha = 0.7, outlier.shape = NA) +
  geom_jitter(position=position_jitterdodge(), alpha=0.4, size = 0.8) + #, pch = 2
  geom_hline(yintercept = 5.6, linetype = 3, colour='black', alpha = 0.65, show.legend=TRUE) + #mean 2017 POM d15N (Oligotrophic regime, Diver collected, Reef)
  geom_hline(yintercept = 6.6, linetype = 4, colour='black', alpha = 0.65, show.legend=TRUE) + #mean 2017 POM d15N (Oligotrophic regime, Pump collected, Offshore)
  geom_hline(yintercept = 5.3, linetype = 2, colour='black', alpha = 0.65, show.legend=TRUE) + #mean 2015 POM d15N (Upwelling regime)
  geom_hline(yintercept = 6.4, linetype = 1, colour='black', alpha = 0.65, show.legend=TRUE) + #mean 2017 Plankton d15N
  #scale_linetype_manual(labels = c("POM", "POM", "POM", "Plankton"), values = 4) +
  scale_linetype_manual(name = "Resources", values = c(4,4), guide = "legend") + #aesthetics = "hline_colour", guide = "legend"
  ylab(expression("Host  " * {delta}^15*N~('\u2030'))) +
  scale_y_continuous(limits = c(3.95, 8.05), breaks = c(4, 4.5, 5, 5.5, 6, 6.5, 7, 7.5, 8)) +
  scale_fill_manual("Bleaching", values=c("Before"= "#56B4E9","After"= "#E69F00"), labels=c("Before","After")) + #colorblind friendly
  theme(axis.text.x=element_text(vjust=0.5, size=10, face="italic"), panel.background = element_rect(fill = "white", colour = "black"), legend.position = "none") +  #
  guides(line = guide_legend(order = 1))

plot.d15N.year

#ggsave("Maldives_Host_d15N_Year.pdf", plot = plot.d15N.year, device = cairo_pdf, width = 7, height = 4, units = "in", dpi = 1200)
```

```{r}
d15N.gal <- host.2015.2017 %>% 
  filter(Coral == "Galaxea") %>% 
  ggplot(aes(x=Depth, y=Host_d15N, fill=Bleaching)) + 
  facet_wrap(~Coral_species) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA) +
  geom_jitter(position=position_jitterdodge(), alpha=0.4, size = 0.8) + #, pch = 2
  geom_hline(yintercept = 5.6, linetype = 3, colour='black', alpha = 0.65) + #mean 2017 POM d15N (Oligotrophic regime, Diver collected, Reef)
  geom_hline(yintercept = 6.6, linetype = 4, colour='black', alpha = 0.65) + #mean 2017 POM d15N (Oligotrophic regime, Pump collected, Offshore)
  geom_hline(yintercept = 5.3, linetype = 2, colour='black', alpha = 0.65) + #mean 2015 POM d15N (Upwelling regime)
  geom_hline(yintercept = 6.4, linetype = 1, colour='black', alpha = 0.65) + #mean 2017 Plankton d15N
  ylab(expression("Host  " * {delta}^15*N~('\u2030'))) +
  scale_y_continuous(limits = c(3.95, 8.05), breaks = c(4, 4.5, 5, 5.5, 6, 6.5, 7, 7.5, 8)) +
  scale_fill_manual("Bleaching", values=c("Before"= "#56B4E9","After"= "#E69F00"), labels=c("Before","After")) + #colorblind friendly
  theme(axis.text.x=element_text(vjust=0.5, size=10, face="italic"), panel.background = element_rect(fill = "white", colour = "grey50"), legend.position="none", axis.title.x=element_blank())

d15N.gal
```

```{r}
d15N.pach <- host.2015.2017 %>% 
  filter(Coral == "Pachyseris") %>% 
  ggplot(aes(x=Depth, y=Host_d15N, fill=Bleaching)) + 
  facet_wrap(~Coral_species) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA) +
  geom_jitter(position=position_jitterdodge(), alpha=0.4, size = 0.8) + #, pch = 2
  geom_hline(yintercept = 5.6, linetype = 3, colour='black', alpha = 0.65) + #mean 2017 POM d15N (Oligotrophic regime, Diver collected, Reef)
  geom_hline(yintercept = 6.6, linetype = 4, colour='black', alpha = 0.65) + #mean 2017 POM d15N (Oligotrophic regime, Pump collected, Offshore)
  geom_hline(yintercept = 5.3, linetype = 2, colour='black', alpha = 0.65) + #mean 2015 POM d15N (Upwelling regime)
  geom_hline(yintercept = 6.4, linetype = 1, colour='black', alpha = 0.65) + #mean 2017 Plankton d15N
  ylab(expression("Host  " * {delta}^15*N~('\u2030'))) +
  scale_y_continuous(limits = c(3.95, 8.05), breaks = c(4, 4.5, 5, 5.5, 6, 6.5, 7, 7.5, 8)) +
  scale_fill_manual("Bleaching", values=c("Before"= "#56B4E9","After"= "#E69F00"), labels=c("Before","After")) + #colorblind friendly
  theme(axis.text.x=element_text(vjust=0.5, size=10, face="italic"), panel.background = element_rect(fill = "white", colour = "grey50"), legend.position="none", axis.title.x=element_blank())

d15N.pach
```

```{r}
d15N.poci <- host.2015.2017 %>% 
  filter(Coral == "Pocillopora") %>% 
  ggplot(aes(x=Depth, y=Host_d15N, fill=Bleaching)) + 
  facet_wrap(~Coral_species) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA) +
  geom_jitter(position=position_jitterdodge(), alpha=0.4, size = 0.8) + #, pch = 2
  geom_hline(yintercept = 5.6, linetype = 3, colour='black', alpha = 0.65) + #mean 2017 POM d15N (Oligotrophic regime, Diver collected, Reef)
  geom_hline(yintercept = 6.6, linetype = 4, colour='black', alpha = 0.65) + #mean 2017 POM d15N (Oligotrophic regime, Pump collected, Offshore)
  geom_hline(yintercept = 5.3, linetype = 2, colour='black', alpha = 0.65) + #mean 2015 POM d15N (Upwelling regime)
  geom_hline(yintercept = 6.4, linetype = 1, colour='black', alpha = 0.65) + #mean 2017 Plankton d15N
  ylab(expression("Host  " * {delta}^15*N~('\u2030'))) +
  scale_y_continuous(limits = c(3.95, 8.05), breaks = c(4, 4.5, 5, 5.5, 6, 6.5, 7, 7.5, 8)) +
  scale_fill_manual("Bleaching", values=c("Before"= "#56B4E9","After"= "#E69F00"), labels=c("Before","After")) + #colorblind friendly
  theme(axis.text.x=element_text(vjust=0.5, size=10, face="italic"), panel.background = element_rect(fill = "white", colour = "grey50"), legend.position="none", axis.title.x=element_blank())

d15N.poci
```

# Host d15N combined plot
```{r}
require(cowplot)

plot <- plot_grid(plot.d15N.year,
                  d15N.gal,
                  d15N.pach,
                  d15N.poci,
                  labels = c('a)', 'b)', 'c)', 'd)'), 
                  hjust = -0.5,
                  vjust = 1, 
                  align = 'vh',
                  scale = c(1, 1, 1, 1),
                  label_size = 12,
                  label_fontface = "plain")

plot

#ggsave("Fig Maldives Host d15N_4-plot_4-POM-lines.pdf", plot = plot, width = 6, height = 5, units = "in", dpi = 1200, device = cairo_pdf)
```

########################################################################

# Host d13C
```{r}
par(mfrow=c(1,3))
plot(Host_d13C ~ Year * Depth * Coral, data=host.2015.2017)
```

```{r}
hist(host.2015.2017$Host_d13C)
```

```{r}
# Assumption - normal distribution
qqnorm(host.2015.2017$Host_d13C,
       ylab="Sample Quantiles")
qqline(host.2015.2017$Host_d13C,
       col="red")
```

```{r}
# Host d13C - LME
host.d13C.lme <- lme(Host_d13C ~ Year * Depth * Coral, random = ~1|Site, data = host.2015.2017, na.action = na.exclude)

host.d13C.lme2 <- lme(Host_d13C ~ Year * Coral, random = ~1|Site, data = host.2015.2017, na.action = na.exclude)

host.d13C.lme3 <- lme(Host_d13C ~ Year * Depth, random = ~1|Site, data = host.2015.2017, na.action = na.exclude)

host.d13C.lme4 <- lme(Host_d13C ~ Depth * Coral, random = ~1|Site, data = host.2015.2017, na.action = na.exclude)
```

```{r}
# model comparison
anova(host.d13C.lme, host.d13C.lme2, host.d13C.lme3, host.d13C.lme4)

# keep model 1 - picked the best model based on lowest AIC value
```

```{r}
summary(host.d13C.lme)
```

```{r}
anova(host.d13C.lme)
```

```{r}
# Extract and display information on all pairwise comparisons of least-squares means
emmeans(host.d13C.lme, pairwise ~ Year * Depth * Coral, adjust = "tukey") #, simple = "Year"
```

```{r}
# Extract and display information on all pairwise comparisons of least-squares means
emmeans(host.d13C.lme, pairwise ~ Depth * Coral, adjust = "tukey", simple = "Depth")
```

```{r}
# estimated deviation between each site average value and the overall average
ranef(host.d13C.lme)
#plot(ranef(host.d13C.lme))
```

```{r}
# examine plots of residuals versus fitted values
residplot(host.d13C.lme, level=2)
plot(host.d13C.lme)
hist(residuals(host.d13C.lme))

# test the assumption of normality of deviations of the conditional means of the random effects from the global intercept
qqnorm(host.d13C.lme, ~ranef(., level=1))
```

```{r}
plot(allEffects(host.d13C.lme), ylab="Host d13C")
```

```{r}
host.d13C.plot <- ggplot(host.2015.2017, aes(x = Depth, y = Host_d13C, fill = Bleaching)) +
  geom_boxplot(outlier.shape= NA, alpha = 0.7) + #lwd=1.05
  facet_wrap(~Coral_species) +
  geom_jitter(position=position_jitterdodge(), alpha=0.4, size = 0.8) +
  ylab(expression("Host  " * {delta}^13*C~('\u2030'))) +
  scale_fill_manual("Bleaching", values=c("Before"= "#56B4E9","After"= "#E69F00")) + #colorblind friendly
  #xlab("Host") +
  theme_classic() +
  theme(text = element_text(size = 12), panel.border = element_rect(fill = NA, color = 'black', size = 1), legend.position="none")

host.d13C.plot

#library(Cairo)
#ggsave("Fig Host d13C_2015-2017.pdf", plot = host.d13C.plot, device = cairo_pdf, width = 6, height = 4, units = "in", dpi = 1200)
```

########################################################################

# Host C:N
```{r}
par(mfrow=c(1,3))
plot(Host_CN_molar.ratio ~ Year * Depth * Coral, data=host.2015.2017)
```

```{r}
hist(host.2015.2017$Host_CN_molar.ratio)
```

```{r}
# Assumption - normal distribution
qqnorm(host.2015.2017$Host_CN_molar.ratio,
       ylab="Sample Quantiles")
qqline(host.2015.2017$Host_CN_molar.ratio,
       col="red")
```

```{r}
# Host CN - LME
host.CN.lme <- lme(Host_CN_molar.ratio ~ Year * Depth * Coral, random = ~1|Site, data = host.2015.2017, na.action = na.exclude)

host.CN.lme2 <- lme(Host_CN_molar.ratio ~ Year * Coral, random = ~1|Site, data = host.2015.2017, na.action = na.exclude)

host.CN.lme3 <- lme(Host_CN_molar.ratio ~ Year * Depth, random = ~1|Site, data = host.2015.2017, na.action = na.exclude)

host.CN.lme4 <- lme(Host_CN_molar.ratio ~ Depth * Coral, random = ~1|Site, data = host.2015.2017, na.action = na.exclude)
```

```{r}
# model comparison
anova(host.CN.lme, host.CN.lme2, host.CN.lme3, host.CN.lme4)

# keep model 2 (removed Depth) - picked the best model based on lowest AIC value
```

```{r}
summary(host.CN.lme2)
```

```{r}
anova(host.CN.lme2)
```

```{r}
# Extract and display information on all pairwise comparisons of least-squares means
emmeans(host.CN.lme2, pairwise ~ Year * Coral, adjust = "tukey", simple = "Year")
```

```{r}
# estimated deviation between each site average value and the overall average
ranef(host.CN.lme2)
#plot(ranef(host.CN.lme2))
```

```{r}
# examine plots of residuals versus fitted values
residplot(host.CN.lme2, level=2)
plot(host.CN.lme2)
hist(residuals(host.CN.lme2))

# test the assumption of normality of deviations of the conditional means of the random effects from the global intercept
qqnorm(host.CN.lme2, ~ranef(., level=1))
```

```{r}
plot(allEffects(host.CN.lme2), ylab="Host C:N")
```

```{r}
host.CN.plot <- ggplot(host.2015.2017, aes(x = Bleaching, y = Host_CN_molar.ratio, fill = Bleaching)) +
  geom_boxplot(outlier.shape= NA, alpha = 0.7) + 
  facet_wrap(~Coral_species, labeller = label_wrap_gen(width = 2)) +
  geom_jitter(position=position_jitterdodge(), alpha=0.4, size = 0.8) +
  ylab("Host  C:N") +
  scale_fill_manual("Bleaching", values=c("Before"= "#56B4E9","After"= "#E69F00")) + #colorblind friendly
  #xlab("Host") +
  theme_classic() +
  theme(text = element_text(size = 12), panel.border = element_rect(fill = NA, color = 'black', size = 1), legend.position="none")

host.CN.plot

#ggsave("Fig Host CN_2015-2017.pdf", plot = host.CN.plot, width = 6, height = 4, units = "in", dpi = 1200)
```

########################################################################

# Host %C
```{r}
par(mfrow=c(1,3))
plot(Host_wt.percent_C_num ~ Year * Depth * Coral, data=host.2015.2017)
```

```{r}
hist(host.2015.2017$Host_wt.percent_C_num)
```

```{r}
# Assumption - normal distribution
qqnorm(host.2015.2017$Host_wt.percent_C_num,
       ylab="Sample Quantiles")
qqline(host.2015.2017$Host_wt.percent_C_num,
       col="red")
```

```{r}
# Host %C - LME
host.C.lme <- lme(Host_wt.percent_C_num ~ Year * Depth * Coral, random = ~1|Site, data = host.2015.2017, na.action = na.exclude)

host.C.lme2 <- lme(Host_wt.percent_C_num ~ Year * Coral, random = ~1|Site, data = host.2015.2017, na.action = na.exclude)

host.C.lme3 <- lme(Host_wt.percent_C_num ~ Year * Depth, random = ~1|Site, data = host.2015.2017, na.action = na.exclude)

host.C.lme4 <- lme(Host_wt.percent_C_num ~ Depth * Coral, random = ~1|Site, data = host.2015.2017, na.action = na.exclude)
```

```{r}
# model comparison
anova(host.C.lme, host.C.lme2, host.C.lme3, host.C.lme4)

# keep model 1 - picked the best model based on lowest AIC value
```

```{r}
summary(host.C.lme)
```

```{r}
anova(host.C.lme)
```

```{r}
# Extract and display information on all pairwise comparisons of least-squares means
emmeans(host.C.lme, pairwise ~ Year * Depth, adjust = "tukey", simple = "Year")
```


```{r}
# Extract and display information on all pairwise comparisons of least-squares means
emmeans(host.C.lme, pairwise ~ Year * Coral, adjust = "tukey", simple = "Year")
```

```{r}
# Extract and display information on all pairwise comparisons of least-squares means
emmeans(host.C.lme, pairwise ~ Depth * Coral, adjust = "tukey", simple = "Depth")
```

```{r}
# estimated deviation between each site average value and the overall average
ranef(host.C.lme)
#plot(ranef(host.C.lme))
```

```{r}
# examine plots of residuals versus fitted values
residplot(host.C.lme, level=2)
plot(host.C.lme)
hist(residuals(host.C.lme))

# test the assumption of normality of deviations of the conditional means of the random effects from the global intercept
qqnorm(host.C.lme, ~ranef(., level=1))
```

```{r}
plot(allEffects(host.C.lme), ylab="Host %C")
```

```{r}
plot <- iso %>% 
  filter(Tissue_type == "Host") %>% 
ggplot(aes(Depth, wt.percent_C_num, fill = Year)) + #, pch = Depth
  facet_wrap(~Coral_species, dir = "h") + #, labeller = label_wrap_gen(width = 2)
  geom_boxplot(outlier.shape= NA, alpha = 0.5) + #alpha = 0.7
  geom_jitter(position=position_jitterdodge(), alpha=0.4, size = 0.5) + #size = 0.8
  scale_fill_manual("Year", values=c("Before"= "#56B4E9","After"= "#E69F00")) + #colorblind friendly
  ylab("Host %C") +
  theme_classic() + 
  theme(axis.text.x=element_text(vjust=0.5, size=12), axis.text.y=element_text(vjust=0.5, size=12), panel.background = element_rect(fill = "white", colour = "grey50"), legend.position = "bottom", plot.margin = unit(c(0,0,0,0), "cm"))

plot

#ggsave("Host percent C boxplot_Depth.pdf", plot = plot, device = cairo_pdf, width = 6, height = 3, units = "in", dpi = 1200)
```

########################################################################

# Host %N
```{r}
par(mfrow=c(1,3))
plot(Host_wt.percent_N_num ~ Year * Depth * Coral, data=host.2015.2017)
```

```{r}
hist(host.2015.2017$Host_wt.percent_N_num)
```

```{r}
# Assumption - normal distribution
qqnorm(host.2015.2017$Host_wt.percent_N_num,
       ylab="Sample Quantiles")
qqline(host.2015.2017$Host_wt.percent_N_num,
       col="red")
```

```{r}
# Host %N - LME
host.N.lme <- lme(Host_wt.percent_N_num ~ Year * Depth * Coral, random = ~1|Site, data = host.2015.2017, na.action = na.exclude)

host.N.lme2 <- lme(Host_wt.percent_N_num ~ Year * Coral, random = ~1|Site, data = host.2015.2017, na.action = na.exclude)

host.N.lme3 <- lme(Host_wt.percent_N_num ~ Year * Depth, random = ~1|Site, data = host.2015.2017, na.action = na.exclude)

host.N.lme4 <- lme(Host_wt.percent_N_num ~ Depth * Coral, random = ~1|Site, data = host.2015.2017, na.action = na.exclude)
```

```{r}
# model comparison
anova(host.N.lme, host.N.lme2, host.N.lme3, host.N.lme4)

# keep model 1 - picked the best model based on lowest AIC value
```

```{r}
summary(host.N.lme)
```

```{r}
anova(host.N.lme)
```

```{r}
# Extract and display information on all pairwise comparisons of least-squares means
emmeans(host.N.lme, pairwise ~ Year * Depth, adjust = "tukey", simple = "Year")
```


```{r}
# Extract and display information on all pairwise comparisons of least-squares means
emmeans(host.N.lme, pairwise ~ Year * Coral, adjust = "tukey", simple = "Year")
```

```{r}
# Extract and display information on all pairwise comparisons of least-squares means
emmeans(host.N.lme, pairwise ~ Depth * Coral, adjust = "tukey", simple = "Depth")
```


```{r}
# estimated deviation between each site average value and the overall average
ranef(host.N.lme)
#plot(ranef(host.N.lme))
```

```{r}
# examine plots of residuals versus fitted values
residplot(host.N.lme, level=2)
plot(host.N.lme)
hist(residuals(host.N.lme))

# test the assumption of normality of deviations of the conditional means of the random effects from the global intercept
qqnorm(host.N.lme, ~ranef(., level=1))
```

```{r}
plot(allEffects(host.N.lme), ylab="Host %N")
```

```{r}
plot <- iso %>% 
  filter(Tissue_type == "Host") %>% 
ggplot(aes(Depth, wt.percent_N_num, fill = Year)) + #, pch = Depth
  facet_wrap(~Coral_species, dir = "h") + #, labeller = label_wrap_gen(width = 2)
  geom_boxplot(outlier.shape= NA, alpha = 0.5) + #alpha = 0.7
  geom_jitter(position=position_jitterdodge(), alpha=0.4, size = 0.5) + #size = 0.8
  scale_fill_manual("Year", values=c("Before"= "#56B4E9","After"= "#E69F00")) + #colorblind friendly
  ylab("Host %N") +
  #coord_fixed(ratio = 1) +
  theme_classic() + 
  theme(strip.text = element_text(face = "italic"), axis.text.x=element_text(vjust=0.5, size=12), axis.text.y=element_text(vjust=0.5, size=12), panel.background = element_rect(fill = "white", colour = "grey50"), legend.position = "bottom", plot.margin = unit(c(0,0,0,0), "cm"))
# strip.background = element_blank(), strip.text = element_blank(),

plot

#ggsave("Host percent N boxplot_Depth.pdf", plot = plot, width = 6, height = 3, units = "in", dpi = 1200)
```

########################################################################
#### SYMBIONTS

# Symbiont d15N
```{r}
par(mfrow=c(1,3))
plot(Symbiont_d15N ~ Year * Depth * Coral, data=sym.2015.2017)
```

```{r}
hist(sym.2015.2017$Symbiont_d15N)
```

```{r}
# Assumption - normal distribution
# Regression models donâ€™t require that outcome variables need to be normally distributed (see: Logistic or Poisson regression models), 
# however MLM (multilevel models) assume that the residuals of the analysis ARE normally distributed

qqnorm(sym.2015.2017$Symbiont_d15N,
       ylab="Sample Quantiles")
qqline(sym.2015.2017$Symbiont_d15N,
       col="red")
```

```{r}
# Symbiont d15N - LME
sym.d15N.lme <- lme(Symbiont_d15N ~ Year * Depth * Coral, random = ~1|Site, data = sym.2015.2017, na.action = na.exclude)

sym.d15N.lme2 <- lme(Symbiont_d15N ~ Year * Coral, random = ~1|Site, data = sym.2015.2017, na.action = na.exclude)

sym.d15N.lme3 <- lme(Symbiont_d15N ~ Year * Depth, random = ~1|Site, data = sym.2015.2017, na.action = na.exclude)

sym.d15N.lme4 <- lme(Symbiont_d15N ~ Depth * Coral, random = ~1|Site, data = sym.2015.2017, na.action = na.exclude)
```

```{r}
# model comparison
anova(sym.d15N.lme, sym.d15N.lme2, sym.d15N.lme3, sym.d15N.lme4)

# Keep model 1 - lowest AIC value
```

```{r}
summary(sym.d15N.lme)
```

```{r}
anova(sym.d15N.lme)
```

```{r}
# Extract and display information on all pairwise comparisons of least-squares means
emmeans(sym.d15N.lme, pairwise ~ Year * Coral, adjust = "tukey", simple = "Year")
```


```{r}
# Extract and display information on all pairwise comparisons of least-squares means
emmeans(sym.d15N.lme, pairwise ~ Year * Depth, adjust = "tukey", simple = "Depth") #simple = "Year"
```

```{r}
# Extract and display information on all pairwise comparisons of least-squares means
emmeans(sym.d15N.lme, pairwise ~ Depth * Coral, adjust = "tukey", simple = "Depth")
```



```{r}
# estimated deviation between each site average value and the overall average
ranef(sym.d15N.lme)
#plot(ranef(sym.d15N.lme))
```

```{r}
# examine plots of residuals versus fitted values
residplot(sym.d15N.lme, level=2)
plot(sym.d15N.lme)
hist(residuals(sym.d15N.lme))

# test the assumption of normality of deviations of the conditional means of the random effects from the global intercept
qqnorm(sym.d15N.lme, ~ranef(., level=1))
```

```{r}
plot(allEffects(sym.d15N.lme), ylab="Symbiont d15N")
```

```{r}
sym.d15N.plot <- ggplot(sym.2015.2017, aes(x=Depth, y=Symbiont_d15N, fill=Bleaching)) + 
  facet_wrap(~Coral_species) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA) +
  geom_jitter(position=position_jitterdodge(), alpha=0.4, size = 0.8) + 
  ylab(expression("Symbiont  " * {delta}^15*N~('\u2030'))) +
  scale_y_continuous(limits = c(2, 7), breaks = c(2, 2.5, 3, 3.5, 4, 4.5, 5, 5.5, 6, 6.5, 7)) +
  scale_fill_manual("Bleaching", values=c("Before"= "#56B4E9","After"= "#E69F00"), labels=c("Before","After")) + #colorblind friendly
  theme(axis.text.x=element_text(vjust=0.5, size=10, face="italic"), panel.background = element_rect(fill = "white", colour = "grey50"))

sym.d15N.plot

#ggsave("Fig Sym d15N.pdf", plot = sym.d15N.plot, device = cairo_pdf, width = 7, height = 4, units = "in", dpi = 1200)
```

########################################################################

# Symbiont d13C
```{r}
par(mfrow=c(1,3))
plot(Symbiont_d13C ~ Year * Depth * Coral, data=sym.2015.2017)
```

```{r}
hist(sym.2015.2017$Symbiont_d13C)
```

```{r}
# Assumption - normal distribution
qqnorm(sym.2015.2017$Symbiont_d13C,
       ylab="Sample Quantiles")
qqline(sym.2015.2017$Symbiont_d13C,
       col="red")
```

```{r}
# Symbiont d13C - LME
sym.d13C.lme <- lme(Symbiont_d13C ~ Year * Depth * Coral, random = ~1|Site, data = sym.2015.2017, na.action = na.exclude)

sym.d13C.lme2 <- lme(Symbiont_d13C ~ Year * Coral, random = ~1|Site, data = sym.2015.2017, na.action = na.exclude)

sym.d13C.lme3 <- lme(Symbiont_d13C ~ Year * Depth, random = ~1|Site, data = sym.2015.2017, na.action = na.exclude)

sym.d13C.lme4 <- lme(Symbiont_d13C ~ Depth * Coral, random = ~1|Site, data = sym.2015.2017, na.action = na.exclude)
```

```{r}
# model comparison
anova(sym.d13C.lme, sym.d13C.lme2, sym.d13C.lme3, sym.d13C.lme4)

# 0.7 difference in AIC between model 1 and model 4 

# What is your goal? Predictive or explanatory modelling? 
## If it is predictive modelling, the simpler model (with fewer parameters) is better. 
## If it is explanatory modelling, you may wish to consider even the second best model because you do not want to leave out an important explanatory variable. 

### Here I am doing explanatory modelling
### therefore I chose model 1, with all three parameters included
```

```{r}
summary(sym.d13C.lme)
```

```{r}
anova(sym.d13C.lme)
```

```{r}
# Extract and display information on all pairwise comparisons of least-squares means
emmeans(sym.d13C.lme, pairwise ~ Depth * Coral, adjust = "tukey", simple = "Depth")
```

```{r}
# estimated deviation between each site average value and the overall average
ranef(sym.d13C.lme)
#plot(ranef(sym.d13C.lme))
```

```{r}
# examine plots of residuals versus fitted values
residplot(sym.d13C.lme, level=2)
plot(sym.d13C.lme)
hist(residuals(sym.d13C.lme))

# test the assumption of normality of deviations of the conditional means of the random effects from the global intercept
qqnorm(sym.d13C.lme, ~ranef(., level=1))
```

```{r}
plot(allEffects(sym.d13C.lme), ylab="Symbiont d13C")
```


```{r}
sym.d13C.plot <- ggplot(sym.2015.2017, aes(x = Depth, y = Symbiont_d13C, fill = Depth)) +
  facet_wrap(~Coral_species) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA) +
  geom_jitter(position=position_jitterdodge(), alpha=0.4, size = 0.8) +
  ylab(expression("Symbiont  " * {delta}^13*C~('\u2030'))) +
  theme(axis.text.x=element_text(vjust=0.5, size=10, face="italic"), panel.background = element_rect(fill = "white", colour = "grey50"))

sym.d13C.plot

#library(Cairo)
#ggsave("Fig Sym d13C.pdf", plot = sym.d13C.plot, device = cairo_pdf, width = 6, height = 4, units = "in", dpi = 1200)
```

########################################################################

# Symbiont C:N
```{r}
par(mfrow=c(1,3))
plot(Symbiont_CN_molar.ratio ~ Year * Depth * Coral, data=sym.2015.2017)
```

```{r}
hist(sym.2015.2017$Symbiont_CN_molar.ratio)
```

```{r}
# Assumption - normal distribution
qqnorm(sym.2015.2017$Symbiont_CN_molar.ratio,
       ylab="Sample Quantiles")
qqline(sym.2015.2017$Symbiont_CN_molar.ratio,
       col="red")
```

```{r}
# Symbiont CN - LME
sym.CN.lme <- lme(Symbiont_CN_molar.ratio ~ Year * Depth * Coral, random = ~1|Site, data = sym.2015.2017, na.action = na.exclude)

sym.CN.lme2 <- lme(Symbiont_CN_molar.ratio ~ Year * Coral, random = ~1|Site, data = sym.2015.2017, na.action = na.exclude)

sym.CN.lme3 <- lme(Symbiont_CN_molar.ratio ~ Year * Depth, random = ~1|Site, data = sym.2015.2017, na.action = na.exclude)

sym.CN.lme4 <- lme(Symbiont_CN_molar.ratio ~ Depth * Coral, random = ~1|Site, data = sym.2015.2017, na.action = na.exclude)
```

```{r}
# model comparison
anova(sym.CN.lme, sym.CN.lme2, sym.CN.lme3, sym.CN.lme4)

# keep model 2 (removed Depth) - picked the best model based on lowest AIC value
```

```{r}
summary(sym.CN.lme2)
```

```{r}
anova(sym.CN.lme2)
```

```{r}
# Extract and display information on all pairwise comparisons of least-squares means
emmeans(sym.CN.lme2, pairwise ~ Year, adjust = "tukey")
```

```{r}
# Extract and display information on all pairwise comparisons of least-squares means
emmeans(sym.CN.lme2, pairwise ~ Coral, adjust = "tukey")
```

```{r}
# estimated deviation between each site average value and the overall average
ranef(sym.CN.lme2)
#plot(ranef(sym.CN.lme2))
```

```{r}
# examine plots of residuals versus fitted values
residplot(sym.CN.lme2, level=2)
plot(sym.CN.lme2)
hist(residuals(sym.CN.lme2))

# test the assumption of normality of deviations of the conditional means of the random effects from the global intercept
qqnorm(sym.CN.lme2, ~ranef(., level=1))
```

```{r}
plot(allEffects(sym.CN.lme2), ylab="Symbiont C:N")
```

```{r}
sym.CN.plot <- ggplot(sym.2015.2017, aes(x = Bleaching, y = Symbiont_CN_molar.ratio, fill = Bleaching)) +
  geom_boxplot(outlier.shape= NA, alpha = 0.7) + 
  facet_wrap(~Coral_species, labeller = label_wrap_gen(width = 2)) +
  geom_jitter(position=position_jitterdodge(), alpha=0.4, size = 0.8) +
  ylab("Symbiont  C:N") +
  scale_fill_manual("Bleaching", values=c("Before"= "#56B4E9","After"= "#E69F00")) + #colorblind friendly
  #xlab("Host") +
  theme_classic() +
  theme(text = element_text(size = 12), panel.border = element_rect(fill = NA, color = 'black', size = 1), legend.position="none")

sym.CN.plot

#ggsave("Fig Sym CN.pdf", plot = sym.CN.plot, width = 6, height = 4, units = "in", dpi = 1200)
```

########################################################################

# Symbiont %C
```{r}
par(mfrow=c(1,3))
plot(Symbiont_wt.percent_C_num ~ Year * Depth * Coral, data=sym.2015.2017)
```

```{r}
hist(sym.2015.2017$Symbiont_wt.percent_C_num)
```

```{r}
# Assumption - normal distribution
qqnorm(sym.2015.2017$Symbiont_wt.percent_C_num,
       ylab="Sample Quantiles")
qqline(sym.2015.2017$Symbiont_wt.percent_C_num,
       col="red")
```

```{r}
# Symbiont %C - LME
sym.C.lme <- lme(Symbiont_wt.percent_C_num ~ Year * Depth * Coral, random = ~1|Site, data = sym.2015.2017, na.action = na.exclude)

sym.C.lme2 <- lme(Symbiont_wt.percent_C_num ~ Year * Coral, random = ~1|Site, data = sym.2015.2017, na.action = na.exclude)

sym.C.lme3 <- lme(Symbiont_wt.percent_C_num ~ Year * Depth, random = ~1|Site, data = sym.2015.2017, na.action = na.exclude)

sym.C.lme4 <- lme(Symbiont_wt.percent_C_num ~ Depth * Coral, random = ~1|Site, data = sym.2015.2017, na.action = na.exclude)
```

```{r}
# model comparison
anova(sym.C.lme, sym.C.lme2, sym.C.lme3, sym.C.lme4)

# keep model 1 - picked the best model based on lowest AIC value
```

```{r}
summary(sym.C.lme)
```

```{r}
anova(sym.C.lme)
```

```{r}
# Extract and display information on all pairwise comparisons of least-squares means
emmeans(sym.C.lme, pairwise ~ Year, adjust = "tukey")
```

```{r}
# Extract and display information on all pairwise comparisons of least-squares means
emmeans(sym.C.lme, pairwise ~ Coral, adjust = "tukey")
```


```{r}
# estimated deviation between each site average value and the overall average
ranef(sym.C.lme)
#plot(ranef(sym.C.lme))
```

```{r}
# examine plots of residuals versus fitted values
residplot(sym.C.lme, level=2)
plot(sym.C.lme)
hist(residuals(sym.C.lme))

# test the assumption of normality of deviations of the conditional means of the random effects from the global intercept
qqnorm(sym.C.lme, ~ranef(., level=1))
```

```{r}
plot(allEffects(sym.C.lme), ylab="Symbiont %C")
```

# Symbiont %C by Depth, Bleaching
```{r}
sym.C.depth <- ggplot(sym.2015.2017, aes(x = Depth, y = Symbiont_wt.percent_C_num, fill = Bleaching)) +
  geom_boxplot(outlier.shape= NA, alpha = 0.7) + 
  facet_wrap(~Coral_species, labeller = label_wrap_gen(width = 2)) +
  geom_jitter(position=position_jitterdodge(), alpha=0.4, size = 0.8) +
  ylab("Symbiont  % C") +
  scale_fill_manual("Bleaching", values=c("Before"= "#56B4E9","After"= "#E69F00")) + #colorblind friendly
  xlab("") +
  theme_classic() +
  theme(text = element_text(size = 12), panel.border = element_rect(fill = NA, color = 'black', size = 1), legend.position="none")

sym.C.depth
```

```{r}
plot <- iso %>% 
  filter(Tissue_type == "Symbiont") %>% 
ggplot(aes(Depth, wt.percent_C_num, fill = Year)) + #, pch = Depth
  facet_wrap(~Coral_species, dir = "h") + #, labeller = label_wrap_gen(width = 2)
  geom_boxplot(outlier.shape= NA, alpha = 0.5) + 
  geom_jitter(position=position_jitterdodge(), alpha=0.4, size = 0.5) +
  scale_fill_manual("Year", values=c("Before"= "#56B4E9","After"= "#E69F00")) + #colorblind friendly
  ylab("Symbiont %C") +
  theme_classic() + 
  theme(axis.text.x=element_text(vjust=0.5, size=12), axis.text.y=element_text(vjust=0.5, size=12), panel.background = element_rect(fill = "white", colour = "grey50"), legend.position = "bottom", plot.margin = unit(c(0,0,0,0), "cm"))

plot

#ggsave("Symbiont percent C boxplot_Depth.pdf", plot = plot, device = cairo_pdf, width = 6, height = 3, units = "in", dpi = 1200)
```

########################################################################

# Symbiont %N
```{r}
par(mfrow=c(1,3))
plot(Symbiont_wt.percent_N_num ~ Year * Depth * Coral, data=sym.2015.2017)
```

```{r}
hist(sym.2015.2017$Symbiont_wt.percent_N_num)
```

```{r}
# Assumption - normal distribution
qqnorm(sym.2015.2017$Symbiont_wt.percent_N_num,
       ylab="Sample Quantiles")
qqline(sym.2015.2017$Symbiont_wt.percent_N_num,
       col="red")
```

```{r}
# Symbiont %N - LME
sym.N.lme <- lme(Symbiont_wt.percent_N_num ~ Year * Depth * Coral, random = ~1|Site, data = sym.2015.2017, na.action = na.exclude)

sym.N.lme2 <- lme(Symbiont_wt.percent_N_num ~ Year * Coral, random = ~1|Site, data = sym.2015.2017, na.action = na.exclude)

sym.N.lme3 <- lme(Symbiont_wt.percent_N_num ~ Year * Depth, random = ~1|Site, data = sym.2015.2017, na.action = na.exclude)

sym.N.lme4 <- lme(Symbiont_wt.percent_N_num ~ Depth * Coral, random = ~1|Site, data = sym.2015.2017, na.action = na.exclude)
```

```{r}
# model comparison
anova(sym.N.lme, sym.N.lme2, sym.N.lme3, sym.N.lme4)

# Model 4 has lowest AIC, but
# 1.3 difference in AIC between Model 4 and 1 

# 2.5 difference in AIC between Model 2 and 1

# 3.9 difference in AIC between Model 4 and 1

# What is your goal? Predictive or explanatory modelling? 
## If it is predictive modelling, the simpler model (with fewer parameters) is better. 
## If it is explanatory modelling, you may wish to consider even the second best model because you do not want to leave out an important explanatory variable. 

### Here I am doing explanatory modelling
### therefore I chose model 1, with all three parameters included
```

```{r}
summary(sym.N.lme)
```

```{r}
anova(sym.N.lme)
```

```{r}
# Extract and display information on all pairwise comparisons of least-squares means
emmeans(sym.N.lme, pairwise ~ Year * Depth * Coral, adjust = "tukey", simple = "Depth")
```

```{r}
# Extract and display information on all pairwise comparisons of least-squares means
emmeans(sym.N.lme, pairwise ~ Coral, adjust = "tukey")
```


```{r}
# estimated deviation between each site average value and the overall average
ranef(sym.N.lme)
#plot(ranef(sym.N.lme))
```

```{r}
# examine plots of residuals versus fitted values
residplot(sym.N.lme, level=2)
plot(sym.N.lme)
hist(residuals(sym.N.lme))

# test the assumption of normality of deviations of the conditional means of the random effects from the global intercept
qqnorm(sym.N.lme, ~ranef(., level=1))
```

```{r}
plot(allEffects(sym.N.lme), ylab="Symbiont %N")
```

```{r}
plot <- iso %>% 
  filter(Tissue_type == "Symbiont") %>% 
ggplot(aes(Depth, wt.percent_N_num, fill = Year)) + #, pch = Depth
  facet_wrap(~Coral_species, dir = "h") + #, labeller = label_wrap_gen(width = 2)
  geom_boxplot(outlier.shape= NA, alpha = 0.5) + #alpha = 0.7
  geom_jitter(position=position_jitterdodge(), alpha=0.4, size = 0.5) + #size = 0.8
  scale_fill_manual("Year", values=c("Before"= "#56B4E9","After"= "#E69F00")) + #colorblind friendly
  ylab("Symbiont %N") +
  theme_classic() + 
  theme(strip.text = element_text(face = "italic"), axis.text.x=element_text(vjust=0.5, size=12), axis.text.y=element_text(vjust=0.5, size=12), panel.background = element_rect(fill = "white", colour = "grey50"), legend.position = "bottom", plot.margin = unit(c(0,0,0,0), "cm"))

plot

#ggsave("Symbiont percent N boxplot_Depth.pdf", plot = plot, width = 6, height = 3, units = "in", dpi = 1200)
```


########################################################################

# Figures 

# Isotope ellipse plot, by Year - Horizontal
```{r}
new_labels <- c("Galaxea fascicularis" = "Galaxea fascicularis", "Pachyseris speciosa" = "Pachyseris speciosa", "Pocillopora verrucosa" = "Pocillopora verrucosa")

plot <- iso %>% 
  ggplot(aes(d13C, d15N, color = Year, pch = Depth)) + 
  facet_grid(Tissue_type ~ Coral_species) +
  geom_point(alpha = 0.3, na.rm = TRUE, size = .7) +
  stat_ellipse(aes(linetype=Depth), level = .4, size = .6) + #size = .7
  scale_color_manual("Year", values=c("Before"= "#56B4E9","After"= "#E69F00")) + #colorblind friendly
  xlab(expression({delta}^13*C~'\u2030')) +
  ylab(expression({delta}^15*N~'\u2030')) +
  xlim(-20.5,-8.8) +
  ylim(2,8) +
  coord_fixed(ratio = 1) +
  theme_classic() + 
  theme(axis.text.x=element_text(vjust=0.5, size=12), axis.text.y=element_text(vjust=0.5, size=12), panel.background = element_rect(fill = "white", colour = "black"), legend.position = "none") 

plot

#ggsave("Fig Maldives isotope ellipses_horizontal_noLegend_noLetters.pdf", plot = plot, device = cairo_pdf, width = 9, height = 4, units = "in", dpi = 1200)
```

Change in d13C vs. Change in d15N
```{r}
#pch shallow, mesophotic 0, 15, 1, 16, 2, 17

combined <- iso.diff %>% 
  #filter(Fraction == "Host") %>% 
    ggplot(aes(diff_d13C, diff_d15N, shape = Coral)) +
      facet_wrap(~Fraction, dir = 'h') +
      geom_point(size = 2) +
      geom_segment(aes(xend=diff_d13C, yend = diff_d15N), x = 0, y=0) +
      scale_shape_manual(values = c(0, 15, 1, 16, 2, 17)) +
      xlab(expression("Mean  " * {delta}^13*C * " change")) +
      ylab(expression("Mean  " * {delta}^15*N * " change")) +
      coord_fixed() +
      scale_x_continuous(limits = c(-1.25, 1.25)) +
      scale_y_continuous(limits = c(-1.25, 1.25)) +
      theme_bw() +
      theme(strip.background = element_rect(fill="white"))

combined

#ggsave("Change-d13C-d15N_Host-Sym.pdf", plot = combined, device = cairo_pdf, width = 8, height = 4, units = "in", dpi = 1200)
```


Change in d13C vs. Change in %C
```{r}
combined <- iso.diff %>% 
  #filter(Fraction == "Host") %>% 
    ggplot(aes(diff_d13C, diff_C_percent, shape = Coral)) +
      facet_wrap(~Fraction, dir = 'h') +
      geom_point(size = 2) +
      geom_segment(aes(xend=diff_d13C, yend = diff_C_percent), x = 0, y=0) +
      scale_shape_manual(values = c(0, 15, 1, 16, 2, 17)) +
      ylab("%Carbon change") +
      xlab(expression("Mean  " * {delta}^13*C * " change")) +
      #coord_fixed() +
      scale_y_continuous(limits = c(-6.7, 6.7), breaks = c(-6.0, -4.0, -2.0, 0, 2.0, 4.0, 6.0)) + #c(-7, 7))
      scale_x_continuous(limits = c(-1.27, 1.27), breaks = c(-1.0, -0.5, 0, 0.5, 1.0)) + #c(-2, 2)
      theme_bw() +
      theme(strip.background = element_rect(fill="white")) #, legend.position = "none"

combined

#ggsave("Change_d13C_Percent-C_Host-Sym.pdf", plot = combined, device = cairo_pdf, width = 8, height = 3, units = "in", dpi = 1200)
```

Host C:N vs. Host d13C
```{r}
plot <- host.2015.2017 %>% 
ggplot(aes(Host_CN_molar.ratio, Host_d13C, color = Coral, pch = Bleaching)) + 
  #facet_wrap(~Coral, dir = "h") +
  geom_point(alpha = 0.3, na.rm = TRUE, size = 1.5) + #alpha = 0.3
  stat_ellipse(aes(linetype=Bleaching), level = .4, size = .7) + 
  #scale_color_manual("Bleaching", values=c("Before"= "#56B4E9","After"= "#E69F00")) + #colorblind friendly
  xlab("Host C:N") + 
  ylab(expression("Host " * {delta}^13*C~('\u2030'))) +
  #xlim(-20.8,-8.8) + #(-20,-12)
  #ylim(2,8) + # (4,8)
  #coord_fixed(ratio = 1) +
  theme_classic() + 
  theme(axis.text.x=element_text(vjust=0.5, size=12), axis.text.y=element_text(vjust=0.5, size=12), panel.background = element_rect(fill = "white", colour = "grey50"), legend.position = "bottom", plot.margin = unit(c(0,0,0,0), "cm"))

plot

#ggsave("Host CN vs Host d13C_all-coral.pdf", plot = plot, device = cairo_pdf, width = 6.5, height = 5, units = "in", dpi = 1200)
```

Host d13C vs. Big delta 15N
```{r}
plot <- paired %>% 
  ggplot(aes(d13C_Host, d15N_host.sym, color = Year, pch = Depth)) +
  facet_wrap(~Coral, dir = "h") +
  geom_point(alpha = 0.3, na.rm = TRUE, size = 1) + #alpha = 0.3, size = 1.5, size = 0.6
  stat_ellipse(aes(linetype=Depth), level = .4, size = .6) + #size = .6
  scale_color_manual("Year", values=c("Before"= "#56B4E9","After"= "#E69F00")) + #colorblind friendly
  geom_hline(yintercept = 0, linetype = 2, color= 'grey50', size = 0.4) +
  labs(x=expression(Host~ {delta}^13*C~'(\u2030)'), y=expression({Delta}^15*N ~" "[host-symbiont]~'(\u2030)')) +
  #xlim(-20, -13.7) +  #xlim(-18.7, -14.5)
  #ylim(-0.5, 2.0) +  #ylim(-0.5, 1.6)
  guides(shape = guide_legend(order = 1),
         fill = FALSE) +
  theme(strip.text = element_text(face = "italic"), axis.text.x=element_text(vjust=0.5, size=10), axis.text.y=element_text(vjust=0.5, size=10), panel.background = element_rect(fill = FALSE, colour = "grey50"), legend.box="vertical", legend.margin=margin(), plot.margin = unit(c(0.1, 0.1, 0.1, 0.1), "cm"), legend.position = "none", strip.background = element_rect(fill = FALSE, colour = "grey50"))

plot

#ggsave("Host d13C vs Big delta 15N ellipses.pdf", plot = plot,  device = cairo_pdf, width = 7, height = 3, units = "in", dpi = 1200)
```

Big delta 13C vs. Big delta 15N
```{r}
plot <- paired %>% 
  ggplot(aes(d13C_host.sym, d15N_host.sym, color = Year, pch = Depth)) +
  facet_wrap(~Coral, dir = "h") +
  geom_point(alpha = 0.3, na.rm = TRUE, size = 1) + #alpha = 0.3, size = 1.5, size = 0.6
  stat_ellipse(aes(linetype=Depth), level = .4, size = .6) + #size = .6
  scale_color_manual("Year", values=c("Before"= "#56B4E9","After"= "#E69F00")) + #colorblind friendly
  #geom_point(aes(fill = Year, shape = Depth), size = 2) +
  geom_vline(xintercept = 0, linetype = 2, color= 'grey50', size = 0.4) +
  geom_hline(yintercept = 0, linetype = 2, color= 'grey50', size = 0.4) +
  labs(x=expression({Delta}^13*C~" "[host-symbiont]~'(\u2030)'),y=expression({Delta}^15*N ~" "[host-symbiont]~'(\u2030)')) +
  #xlim(-2, 0.5) +  
  #ylim(-0.5, 2) +  
  #coord_fixed() +
  guides(shape = guide_legend(order = 1),
         fill = FALSE) +
  theme(strip.text = element_text(face = "italic"), axis.text.x=element_text(vjust=0.5, size=10), axis.text.y=element_text(vjust=0.5, size=10), panel.background = element_rect(fill = FALSE, colour = "grey50"), legend.box="vertical", legend.margin=margin(), plot.margin = unit(c(0.1, 0.1, 0.1, 0.1), "cm"), legend.position = "none", strip.background = element_rect(fill = FALSE, colour = "grey50"))

plot

#ggsave("Big delta 13C vs 15N ellipses.pdf", plot = plot,  device = cairo_pdf, width = 7, height = 3, units = "in", dpi = 1200) #Big delta 13C vs 15N ellipses_zoomOut.pdf
```

########################################################################

# Coral Biogeochemical niche -  isotopes with fatty acids

```{r}
iso.FA <- read.csv(file = "~/Documents/Rprojects/PhD\ Rprojects/Maldives\ thermal\ stress\ paper_Rproject/Maldives_isotopes-FA_Master.csv", header = TRUE)

# absolute of d13C data (negative numbers cause problems in analysis)
iso.FA$d13C <- abs(iso.FA$d13C)

head(iso.FA)
```

```{r}
colnames(iso.FA)
```

```{r}
host <- subset(iso.FA, Fraction == "Host")
dim(host)
```

```{r}
sym <- subset(iso.FA, Fraction == "Symbiont")
dim(sym)
```

### Host nMDS
- sample HM725 removed because did not have %C data

```{r}
host.perc.CN <- subset(host, Sample_ID_iso != "HM725")
```

```{r}
my.mds <- metaMDS(host.perc.CN[,(22:55)], k=2, autotransform = TRUE)
```

```{r}
my.adonis <- adonis(host.perc.CN[,(22:55)] ~ Coral*Depth, data = host.perc.CN, permutations = 9999)
my.adonis
```

```{r}
my.mds$stress
stressplot(my.mds)
plot(my.mds)
```

MDS
```{r}
my.sites.scores <- as.data.frame(scores(my.mds, display = 'sites'))
my.sites.scores <- data.frame(my.sites.scores, host.perc.CN)
my.species.scores <- as.data.frame(scores(my.mds, display = 'species'))
my.species.scores$Species <- row.names(my.species.scores)
```

```{r}
b1 <- ggplot()+
  geom_point(data = my.sites.scores, aes(y=NMDS2, x=NMDS1, color=Coral, shape=Depth), size=2.5)+
  scale_color_manual("Coral", values=c("Galaxea"= 'black',"Pachyseris"='grey', 'Pocillopora'='turquoise'))+
  theme_classic()

b1
```

```{r}
my.hull <- my.sites.scores %>% group_by(Coral)%>%
   do({
    x=.
    x[chull(x$NMDS1, x$NMDS2),]
  })
```


```{r}
b1 <- b1 + stat_ellipse(data = my.hull, aes(y=NMDS2, x=NMDS1, color=Coral), linetype="solid", size=1.25, level=0.40)
b1

#ggsave("nMDS_Maldives_2017_Host_isotopes_percentC-N_FA.pdf", plot = b1, width = 7, height = 5, units = "in", dpi = 1200)
```

### Symbiont nMDS

```{r}
my.mds <- metaMDS(sym[,(22:55)], k=2, autotransform = TRUE)
```

```{r}
my.adonis <- adonis(sym[,(22:55)] ~ Coral*Depth, data = sym, permutations = 9999)
my.adonis
```

```{r}
my.mds$stress
stressplot(my.mds)
plot(my.mds)
```

MDS
```{r}
my.sites.scores <- as.data.frame(scores(my.mds, display = 'sites'))
my.sites.scores <- data.frame(my.sites.scores, sym)
my.species.scores <- as.data.frame(scores(my.mds, display = 'species'))
my.species.scores$Species <- row.names(my.species.scores)
```

```{r}
b1 <- ggplot()+
  geom_point(data = my.sites.scores, aes(y=NMDS2, x=NMDS1, color=Coral, shape=Depth), size=2.5)+
  scale_color_manual("Coral", values=c("Galaxea"= 'black',"Pachyseris"='grey', 'Pocillopora'='turquoise'))+
  theme_classic()

b1
```

```{r}
my.hull <- my.sites.scores %>% group_by(Coral)%>%
   do({
    x=.
    x[chull(x$NMDS1, x$NMDS2),]
  })
```


```{r}
b1 <- b1 + stat_ellipse(data = my.hull, aes(y=NMDS2, x=NMDS1, color=Coral), linetype="solid", size=1.25, level=0.40)
b1

#ggsave("nMDS_Maldives_2017_Sym_isotopes_percentC-N_FA.pdf", plot = b1, width = 7, height = 5, units = "in", dpi = 1200)
```


########################################################################

# Session Info
```{r}
sessionInfo()
```

